<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SANITA â€” Sesli Veri & Sohbet AsistanÄ± (Tam)</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.css" rel="stylesheet"/>
<style>
:root{--bg:#020617;--card:#071726;--accent:#46e0b2;--muted:#98b3a8}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#000814,#001d3d);font-family:Inter,system-ui,Segoe UI,Arial;color:#e8ffff}
.center{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
.card{width:980px;max-width:96%;border-radius:14px;padding:20px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 30px 90px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.title{font-weight:800;font-size:18px;color:var(--accent)}
.subtitle{font-size:13px;color:var(--muted)}
.controls{display:flex;gap:8px;align-items:center}
.keyBadge{font-size:13px;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);color:var(--muted)}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 12px;border-radius:8px;cursor:pointer}
.main{display:flex;gap:16px;margin-top:16px;align-items:flex-start}
.left{width:320px;display:flex;flex-direction:column;align-items:center;gap:14px}
.micOuter{position:relative;width:220px;height:220px;border-radius:999px;display:flex;align-items:center;justify-content:center}
.ring{position:absolute;width:420px;height:420px;border-radius:999px;left:50%;transform:translateX(-50%) scale(.9);pointer-events:none;opacity:0;transition:opacity .12s,transform .25s}
.ring.on{opacity:1;transform:translateX(-50%) scale(1);animation:ringPulse 1.6s infinite}
@keyframes ringPulse{0%{box-shadow:0 0 0 0 rgba(70,224,178,0.12)}60%{box-shadow:0 0 0 36px rgba(70,224,178,0)}100%{box-shadow:0 0 0 0 rgba(70,224,178,0)}}
.micBtn{width:160px;height:160px;border-radius:999px;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,var(--accent),#2fd9a2);color:#042018;font-size:46px;font-weight:900;cursor:pointer;box-shadow:0 24px 70px rgba(0,0,0,0.45)}
.wave{width:360px;height:90px;margin-top:8px;display:flex;align-items:flex-end;gap:6px;opacity:0;transition:opacity .1s}
.bar{width:10px;background:linear-gradient(180deg,var(--accent),#34d399);border-radius:6px;height:12px;transition:height .06s}
.transcript{min-height:48px;text-align:center;color:#dff8f0;font-size:15px}
.right{flex:1;display:flex;flex-direction:column;gap:12px}
.responseBox{padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);min-height:120px;position:relative;overflow:hidden}
.resLabel{font-size:13px;color:var(--muted);margin-bottom:6px}
.userText{font-size:14px;color:#cdeee0;margin-bottom:6px}
.resText{font-size:16px;line-height:1.45;color:#e6fff4;white-space:pre-wrap}
.chartWrap{margin-top:8px;background:rgba(255,255,255,0.02);border-radius:8px;padding:8px}
.small{font-size:12px;color:var(--muted)}
.footer{margin-top:12px;text-align:center;color:var(--muted);font-size:13px}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:40}
.modalCard{background:linear-gradient(180deg,#071726,#05202a);padding:14px;border-radius:10px;width:420px;max-width:94%}
.input{width:100%;padding:8px;border-radius:8px;border:none;background:#022a2b;color:#e6fff4}
.row{display:flex;gap:8px;align-items:center}
@media(max-width:920px){ .main{flex-direction:column} .left{width:100%} .micOuter{width:140px;height:140px} .micBtn{width:110px;height:110px;font-size:34px} .wave{width:260px} }
</style>
</head>
<body>
<div class="center">
  <div class="card" role="main" aria-label="Sanita Asistan">
    <div class="header">
      <div>
        <div class="title">SANITA PAKETLEME BILGI & SOHBET ASISTANI</div>
        <div class="subtitle">Sesli komutla veri sorgula, grafik Ã§izdir, sohbet et â€” OpenAI + yerel veri</div>
      </div>
      <div class="controls">
        <div id="keyStatus" class="keyBadge">OpenAI: YOK</div>
        <button id="btnSetKey" class="btn">OpenAI AnahtarÄ±</button>
        <button id="btnClearKey" class="btn">AnahtarÄ± Temizle</button>
      </div>
    </div>

    <div class="main">
      <div class="left">
        <div class="micOuter">
          <div id="ring" class="ring" aria-hidden="true"></div>
          <button id="micBtn" class="micBtn" title="Dinle">ðŸŽ¤</button>
        </div>

        <div id="wave" class="wave" aria-hidden="true">
          <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
          <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </div>

        <div id="transcript" class="transcript">Mikrofona dokunun ve sorun (Ã¶rnek: "SOFRA iÃ§in ne kadar Ã¼retim yapÄ±ldÄ±?").</div>
        <div class="small">Not: EÄŸer mikrofon izni Ã§Ä±kmazsa Chrome site ayarlarÄ±ndan mikrofonu aÃ§Ä±n.</div>
      </div>

      <div class="right">
        <div class="responseBox">
          <div class="resLabel">Cevap (YazÄ±lÄ± & Sesli)</div>
          <div id="userText" class="userText"></div>
          <div id="resText" class="resText">Cevap burada gÃ¶rÃ¼necek.</div>
        </div>

        <div class="chartWrap" style="display:none">
          <canvas id="chartCanvas" height="220"></canvas>
        </div>

        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="small">GÃ¶mÃ¼lÃ¼ veri: Ekim KÃ¼mÃ¼latif (Firma toplamlarÄ± & aylÄ±k Ã¶zet)</div>
          <div>
            <button id="btnShowExamples" class="btn">Ã–rnek Sorular</button>
            <button id="btnClearOutput" class="btn">Temizle</button>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">Not: OpenAI anahtarÄ± girilirse asistan sohbet (gÃ¼ndelik) ve daha doÄŸal cevaplar verebilir.</div>
  </div>
</div>

<!-- modal for API key -->
<div id="keyModal" class="modal" aria-hidden="true">
  <div class="modalCard">
    <div style="font-weight:700;color:#cdeee0">OpenAI API AnahtarÄ±nÄ± Gir</div>
    <div style="margin-top:6px;color:var(--muted);font-size:13px">Anahtar tarayÄ±cÄ±da saklanÄ±r (localStorage). sk- ile baÅŸlar.</div>
    <div style="margin-top:10px">
      <input id="apiInput" class="input" placeholder="sk-..." />
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="saveKeyBtn" class="btn">Kaydet</button>
      <button id="cancelKeyBtn" class="btn">Ä°ptal</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
/* ================= CONFIG & GOMULU VERI ================= */
/* SUMMARY ve KUM gÃ¶mÃ¼lÃ¼ (senin gÃ¶nderdiÄŸin Ã¶zet tablodan) */
const SUMMARY = {
  KISI_SAYISI: 418,
  CALISMA_SURESI: 951.75,
  URETIM_MIKTARI: 212571,
  TOPLAM_HAM: 99126.68,
  HAMMADDE_FIRE: 5.48,
  OMK_FIRE: 28,
  OPP_FIRE: 15.8
};

const KUM = [
  {"FIRMA":"SOFRA","URETIM":31477,"HAM_MIK":29055.17},
  {"FIRMA":"KERVAN","URETIM":764,"HAM_MIK":764},
  {"FIRMA":"RECEP CAN","URETIM":1952,"HAM_MIK":4760.07},
  {"FIRMA":"EVERGREEN","URETIM":48122,"HAM_MIK":9921.44},
  {"FIRMA":"BEDIR TEDARIK","URETIM":1964,"HAM_MIK":1702.3},
  {"FIRMA":"ONEN GIDA","URETIM":100,"HAM_MIK":100},
  {"FIRMA":"CELIK NATUREL","URETIM":100,"HAM_MIK":100},
  {"FIRMA":"SEKERCI","URETIM":10484,"HAM_MIK":11828.14},
  {"FIRMA":"GENIM GIDA","URETIM":5173,"HAM_MIK":4760.51},
  {"FIRMA":"AKAR FOOD","URETIM":11454,"HAM_MIK":1170.48},
  {"FIRMA":"MAUN GIDA","URETIM":550,"HAM_MIK":550},
  {"FIRMA":"VENUS","URETIM":3660,"HAM_MIK":2579},
  {"FIRMA":"ANADOLU UNIVERSITESI","URETIM":340,"HAM_MIK":310},
  {"FIRMA":"EKOL FOOD","URETIM":864,"HAM_MIK":723},
  {"FIRMA":"SANITA EVERGREEN","URETIM":672,"HAM_MIK":336},
  {"FIRMA":"MESA","URETIM":70990,"HAM_MIK":9804.16},
  {"FIRMA":"CASH&CARRY","URETIM":13522,"HAM_MIK":15307.8},
  {"FIRMA":"BORTAR","URETIM":797,"HAM_MIK":703.5},
  {"FIRMA":"VKS","URETIM":1794,"HAM_MIK":1002},
  {"FIRMA":"HABIP ALBAYRAK","URETIM":1086,"HAM_MIK":1008.15},
  {"FIRMA":"FATSAT","URETIM":320,"HAM_MIK":320},
  {"FIRMA":"NIOLES","URETIM":750,"HAM_MIK":340.65},
  {"FIRMA":"SALEH","URETIM":4224,"HAM_MIK":1024.32},
  {"FIRMA":"KIRCICEGI","URETIM":50,"HAM_MIK":50},
  {"FIRMA":"MAYA CATERING","URETIM":42,"HAM_MIK":36},
  {"FIRMA":"T DONER","URETIM":500,"HAM_MIK":50},
  {"FIRMA":"FRESH FOOD","URETIM":50,"HAM_MIK":50},
  {"FIRMA":"EGES YEMEK","URETIM":190,"HAM_MIK":190}
];

/* If you later want to add detailed row-level data (daily logs), set ROWS = [...] with keys:
   URETIM_TARIH (YYYY-MM-DD or '6 Ekim' etc), STOK_ISMI, MIKTAR, FIRMA, KULLANILAN HAMMADDE, KULLANILAN HAMMADDE MIKTARI,
   PERSONEL, SURE, OPP FÄ°RE, OMK FÄ°RE, HAMMADDE FÄ°RE, etc.
   For now we'll use KUM + SUMMARY for the requested queries.
*/
const ROWS = []; // leave empty unless you embed full row data

/* ===== DOM refs ===== */
const micBtn = document.getElementById('micBtn');
const ring = document.getElementById('ring');
const wave = document.getElementById('wave');
const transcript = document.getElementById('transcript');
const resText = document.getElementById('resText');
const userText = document.getElementById('userText');
const keyStatus = document.getElementById('keyStatus');
const btnSetKey = document.getElementById('btnSetKey');
const btnClearKey = document.getElementById('btnClearKey');
const keyModal = document.getElementById('keyModal');
const apiInput = document.getElementById('apiInput');
const saveKeyBtn = document.getElementById('saveKeyBtn');
const cancelKeyBtn = document.getElementById('cancelKeyBtn');
const chartWrap = document.querySelector('.chartWrap');
const chartCanvas = document.getElementById('chartCanvas');

let chartInstance = null;

/* ===== OpenAI key storage ===== */
const STORAGE_KEY = 'SANITA_OPENAI_KEY';
let OPENAI_KEY = localStorage.getItem(STORAGE_KEY) || '';
function showStatusKey(){ keyStatus.innerText = OPENAI_KEY ? 'OpenAI: AKTIF' : 'OpenAI: YOK'; }
showStatusKey();

/* ===== voice selection: prefer a Turkish male-like voice if available ===== */
let chosenVoice = null;
function chooseVoice(){
  const voices = speechSynthesis.getVoices();
  if(!voices || !voices.length) return;
  // heuristics: prefer voices whose name suggests male or contain Turkish locale
  let v = voices.find(x=> x.lang && x.lang.toLowerCase().startsWith('tr') && /Emir|Ahmet|Mehmet|Ali|Erdem|Burak|Arda|Serkan|Mahmut/i.test(x.name));
  if(!v) v = voices.find(x=> x.lang && x.lang.toLowerCase().startsWith('tr'));
  if(!v) v = voices[0];
  chosenVoice = v;
}
speechSynthesis.onvoiceschanged = chooseVoice;
chooseVoice();

/* ===== helpers ===== */
function fmt(n){ return (typeof n==='number') ? n.toLocaleString('tr-TR') : String(n); }
function speak(text,opts={interruptRec:true}){
  try{
    if(opts.interruptRec && recognition && recognizing) try{ recognition.stop(); }catch(e){}
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'tr-TR';
    if(chosenVoice) u.voice = chosenVoice;
    u.rate = 1; u.pitch = 1;
    micBtn.disabled = true;
    u.onend = ()=> { micBtn.disabled = false; };
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch(e){
    console.warn('TTS err', e);
    micBtn.disabled = false;
  }
}
function showResponse(userQ, assistantText){
  userText.innerText = userQ ? ('Soru: ' + userQ) : '';
  resText.innerText = assistantText;
}

/* ===== analytics: localAnswer covers many requested questions (from your list) ===== */
function localAnswer(q){
  if(!q) return null;
  const t = q.toLowerCase();

  // 1) Firmaya gore toplam uretim
  for(const r of KUM){
    const name = r.FIRMA.toLowerCase();
    const tokens = name.split(/[\s&\-_\.]+/).filter(Boolean);
    for(const tk of tokens){
      if(t.includes(tk) && tk.length>2){
        return `${r.FIRMA.toUpperCase()} iÃ§in toplam Ã¼retim ${fmt(r.URETIM)} adet. KullanÄ±lan hammadde: ${fmt(r.HAM_MIK)} kg.`;
      }
    }
  }

  // 2) ÅžEKERCÄ° iÃ§in karabiber Ã¶rneÄŸi (Ã¶zellik: eÄŸer ROWS veri yoksa detay verilemez)
  if(t.includes('karabiber')){
    if(ROWS.length===0) return `SatÄ±r dÃ¼zeyinde 'karabiber' verisi yok. DetaylÄ± Excel satÄ±r verisini gÃ¶merseniz 'karabiber' tÃ¼ketimini hesaplarÄ±m.`;
  }

  // 3) GÃ¼n bazlÄ± Ã§alÄ±ÅŸan sayÄ±sÄ± (Ã¶r: 6 Ekim)
  const dateMatch = t.match(/(\d{1,2})\s*ekim/);
  if(dateMatch){
    const day = Number(dateMatch[1]);
    if(ROWS.length===0) return `GÃ¼n bazlÄ± veriler gÃ¶mÃ¼lÃ¼ deÄŸil; ${day} Ekim iÃ§in satÄ±r bazlÄ± kayÄ±t saÄŸlarsanÄ±z Ã§alÄ±ÅŸan sayÄ±sÄ±nÄ± Ã§Ä±karÄ±rÄ±m.`;
    const rowsDay = ROWS.filter(r=> (String(r['URETIM_TARIH']||'')).includes(String(day)));
    const sumPersons = rowsDay.reduce((s,r)=> s + (Number(r['KISI_SAYISI']||r['KÄ°ÅžÄ° SAYISI']||0)||0),0);
    return `${day} Ekim'de toplam Ã§alÄ±ÅŸan sayÄ±sÄ± (satÄ±r toplam): ${sumPersons}`;
  }

  // 4) Ekim ayÄ±nda toplam kaÃ§ kilo pul biber kullanÄ±ldÄ±?
  if(t.includes('pul') && t.includes('biber')){
    if(ROWS.length>0){
      const rowsPul = ROWS.filter(r=> (String(r['KULLANILAN HAMMADDE']||'') + ' ' + String(r['STOK_ISMI']||'')).toLowerCase().includes('pul'));
      const total = rowsPul.reduce((s,r)=> s + (Number(r['KULLANILAN HAMMADDE MÄ°KTARI']||r['KULLANILAN HAMMADDE MIKTARI']||0)||0),0);
      return `Ekim ayÄ±nda toplam pul biber kullanÄ±mÄ±: ${fmt(total)} kg.`;
    } else {
      return 'SatÄ±r dÃ¼zeyinde Ã¼rÃ¼n-hammadde verisi yok; pul biber tÃ¼ketimini hesaplamak iÃ§in detaylÄ± Excel satÄ±r verisini gÃ¶mÃ¼n.';
    }
  }

  // 5) KaÃ§ farklÄ± firma ile Ã§alÄ±ÅŸtÄ±k?
  if(t.includes('kaÃ§') && t.includes('firma')){
    return `Toplam ${KUM.length} farklÄ± firmayla Ã§alÄ±ÅŸÄ±lmÄ±ÅŸ.`;
  }

  // 6) Toplam kullanÄ±lan hammadde miktarÄ± nedir?
  if((t.includes('toplam') && t.includes('hammadde')) || t.includes('toplam hammadde miktarÄ±')){
    return `Ekim ayÄ±nda toplam kullanÄ±lan hammadde: ${fmt(SUMMARY.TOPLAM_HAM)} kg.`;
  }

  // 7) En Ã§ok hangi hammadde kullandÄ±m? -> needs ROWS (types)
  if(t.includes('en Ã§ok') && t.includes('hammadde') && t.includes('hangi')){
    if(ROWS.length===0) {
      // fallback: tell which firm used most hammadde
      const map={}; KUM.forEach(r=> map[r.FIRMA] = (map[r.FIRMA]||0) + (Number(r.HAM_MIK)||0));
      const arr = Object.entries(map).sort((a,b)=> b[1]-a[1]);
      return `Ã–zet veride hammadde tÃ¼rleri ayrÄ± deÄŸil; en Ã§ok toplam hammadde kullanan firma ${arr[0][0]}, ${fmt(arr[0][1])} kg. EÄŸer tÃ¼r bazlÄ± analiz istersen detaylÄ± satÄ±r verisini gÃ¶mÃ¼n.`;
    } else {
      // compute by type
      const map={};
      ROWS.forEach(r=> {
        const tname = (r['HAMMADDE TÃœRÃœ']||r['HAMMADDE TÃœRÃœ']||r['HAMMADDE_TÃœRÃœ']||'').toString().trim().toUpperCase() || (r['KULLANILAN HAMMADDE']||'').toString().trim().toUpperCase();
        if(!tname) return;
        map[tname] = (map[tname]||0) + (Number(r['KULLANILAN HAMMADDE MÄ°KTARI']||r['KULLANILAN HAMMADDE MIKTARI']||0)||0);
      });
      const arr = Object.entries(map).sort((a,b)=> b[1]-a[1]);
      if(arr.length===0) return 'Hammadde tÃ¼rÃ¼ verisi bulunamadÄ±.';
      return `En Ã§ok kullanÄ±lan hammadde ${arr[0][0]}, toplam ${fmt(arr[0][1])} kg.`;
    }
  }

  // 8) En Ã§ok Ã¼retimde kullanÄ±lan hammadde ve kilosu ne kadar?
  if(t.includes('en cok') && t.includes('Ã¼retim') && t.includes('hammadde')){
    if(ROWS.length===0) return 'ÃœrÃ¼n-hammadde eÅŸlemesi satÄ±r verisinde yok; detaylÄ± veri saÄŸlarsanÄ±z hesaplarÄ±m.';
    // compute mapping product->hammadde
    const map={};
    ROWS.forEach(r=>{
      const prod = (r['STOK_ISMI']||r['STOK_ISMI']||'').toString().trim().toUpperCase();
      const ham = Number(r['KULLANILAN HAMMADDE MÄ°KTARI']||r['KULLANILAN HAMMADDE MIKTARI']||0)||0;
      if(!prod) return;
      map[prod] = (map[prod]||0) + ham;
    });
    const arr = Object.entries(map).sort((a,b)=> b[1]-a[1]);
    if(arr.length===0) return 'ÃœrÃ¼n-hammadde verisi yok.';
    return `En Ã§ok hammadde kullanan Ã¼retim ${arr[0][0]}, ${fmt(arr[0][1])} kg.`;
  }

  // 9) En Ã§ok Ã¼retim yaptÄ±ÄŸÄ±m firma hangisi?
  if(t.includes('en Ã§ok') && t.includes('Ã¼retim') && !t.includes('hammadde')){
    const arr = KUM.slice().sort((a,b)=> b.URETIM - a.URETIM);
    return `En Ã§ok Ã¼retim yapÄ±lan firma ${arr[0].FIRMA}, toplam ${fmt(arr[0].URETIM)} adet.`;
  }

  // 10) En Ã§ok hammadde kullandÄ±ÄŸÄ±m firma hangisi?
  if(t.includes('en Ã§ok') && t.includes('hammadde') && t.includes('firma')){
    const arr = KUM.slice().sort((a,b)=> b.HAM_MIK - a.HAM_MIK);
    return `En Ã§ok hammadde kullanan firma ${arr[0].FIRMA}, toplam ${fmt(arr[0].HAM_MIK)} kg.`;
  }

  // 11) Ã‡alÄ±ÅŸma sÃ¼resi nedir?
  if(t.includes('Ã§alÄ±ÅŸma sÃ¼resi') || (t.includes('Ã§alÄ±ÅŸma') && t.includes('sÃ¼re'))){
    return `Toplam Ã§alÄ±ÅŸma sÃ¼resi: ${fmt(SUMMARY.CALISMA_SURESI)} saat.`;
  }

  // 12) 5 Ekim'de kaÃ§ saat Ã§alÄ±ÅŸÄ±ldÄ±?
  if(t.includes('5 ekim') && t.includes('saat')){
    if(ROWS.length===0) return 'GÃ¼nlÃ¼k Ã§alÄ±ÅŸma saati verisi gÃ¶mÃ¼lÃ¼ deÄŸil; detaylÄ± satÄ±r verisi paylaÅŸÄ±rsanÄ±z 5 Ekim iÃ§in hesap yaparÄ±m.';
  }

  // 13) Hammadde - OPP(BOBIN) - OMK fireleri
  if(t.includes('opp') || t.includes('bobin') || (t.includes('omk') || t.includes('koli')) || t.includes('fire')){
    return `AylÄ±k Ã¶zet: Hammadde fire: ${fmt(SUMMARY.HAMMADDE_FIRE)}, OMK (koli) fire: ${fmt(SUMMARY.OMK_FIRE)}, OPP (bobin) fire: ${fmt(SUMMARY.OPP_FIRE)}.`;
  }

  // 14) En Ã§ok fire veren Ã¼rÃ¼n (requires row-level)
  if(t.includes('en Ã§ok') && t.includes('fire') && t.includes('Ã¼rÃ¼n')){
    if(ROWS.length===0) return 'ÃœrÃ¼n bazlÄ± fire verisi gÃ¶mÃ¼lÃ¼ deÄŸil; satÄ±r verisi saÄŸlarsanÄ±z hangi Ã¼rÃ¼nÃ¼n en Ã§ok fire verdiÄŸini hesaplarÄ±m.';
  }

  // 15) 9 Ekim detay sorusu
  if(t.includes('9 ekim')){
    if(ROWS.length===0) return 'GÃ¼nlÃ¼k detay veri gÃ¶mÃ¼lÃ¼ deÄŸil; 9 Ekim iÃ§in satÄ±r bazlÄ± veri saÄŸlarsanÄ±z ayrÄ±ntÄ±lÄ± rapor Ã§Ä±karÄ±rÄ±m.';
  }

  // Grafik komutu: "grafik", "Ã§iz", "grafikte gÃ¶ster"
  if(t.includes('grafik') || t.includes('Ã§iz') || t.includes('grafikte')){
    return { action: 'chart' }; // signal to draw chart by caller
  }

  // Genel fallback: if asks about totals
  if(t.includes('toplam') && t.includes('miktar')){
    const total = KUM.reduce((s,r)=> s + (Number(r.URETIM)||0),0);
    return `AylÄ±k toplam Ã¼retim: ${fmt(total)} adet. Toplam kullanÄ±lan hammadde: ${fmt(SUMMARY.TOPLAM_HAM)} kg.`;
  }

  // if nothing matched, return null to allow OpenAI fallback
  return null;
}

/* ===== OpenAI fallback (gpt-4o-mini) ===== */
async function askOpenAI(q){
  if(!OPENAI_KEY || !OPENAI_KEY.startsWith('sk-')) return null;
  try{
    const prompt = `Kullanici Turkce soru: "${q}". Veri ozetleri: Firma -> uretiim ve toplam ham_mik (Ekim kÃ¼mÃ¼latif). Eger soru veri ile ilgili ise sayisal cevap ver; degilse kisa ve dogal cevap ver.`;
    const body = { model: "gpt-4o-mini", messages: [{role:"system",content:"Turkce veri analizi asistani ve sohbet asistani"}, {role:"user",content:prompt}], max_tokens:600 };
    const r = await fetch('https://api.openai.com/v1/chat/completions', {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+OPENAI_KEY },
      body: JSON.stringify(body)
    });
    const j = await r.json();
    const content = j?.choices?.[0]?.message?.content;
    return content || null;
  }catch(e){ console.warn('openai err', e); return null; }
}

/* ===== Chart drawing util ===== */
function drawFirmChart(){
  const labels = KUM.map(r=> r.FIRMA);
  const data = KUM.map(r=> r.URETIM);
  chartWrap.style.display = 'block';
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(chartCanvas, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Uretim Miktari (adet)', data, backgroundColor: labels.map(()=> 'rgba(70,224,178,0.9)') }] },
    options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
}

/* ===== SpeechRecognition & mic handling ===== */
let recognition = null;
let recognizing = false;

function setupRecognition(){
  if(!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)){
    transcript.innerText = 'TarayÄ±cÄ± ses tanÄ±mayÄ± desteklemiyor. LÃ¼tfen Chrome kullanÄ±n.';
    return false;
  }
  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new Rec();
  recognition.lang = 'tr-TR';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = ()=> { recognizing = true; ring.classList.add('on'); wave.style.opacity = '1'; transcript.innerText = 'DINLENIYOR...'; };
  recognition.onresult = async (ev) => {
    recognizing = false;
    ring.classList.remove('on'); wave.style.opacity = '0';
    const text = ev.results[0][0].transcript;
    transcript.innerText = 'ALGILANAN: ' + text;
    // process
    await handleQuery(text);
  };
  recognition.onerror = (e)=> {
    console.warn('rec err', e);
    recognizing = false;
    ring.classList.remove('on'); wave.style.opacity = '0';
    transcript.innerText = e.error==='not-allowed' ? 'Mikrofon izni engellendi.' : 'Ses algÄ±lama hatasÄ±.';
  };
  recognition.onend = ()=> { recognizing = false; ring.classList.remove('on'); wave.style.opacity = '0'; };
  return true;
}

async function ensureMic(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    // quick audio visual feedback using analyser
    try{
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioCtx.createMediaStreamSource(stream);
      const analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      source.connect(analyser);
      const data = new Uint8Array(analyser.frequencyBinCount);
      function frame(){
        analyser.getByteFrequencyData(data);
        for(let i=0;i<8;i++){
          const v = data[i*2] || 0;
          const h = Math.min(140, 8 + Math.round(v/6));
          document.querySelectorAll('.bar')[i].style.height = h + 'px';
        }
        if(recognizing) requestAnimationFrame(frame);
      }
      frame();
    }catch(e){ console.warn('analyser err', e); }
    return true;
  }catch(e){
    console.warn('getUserMedia err', e);
    transcript.innerText = 'Mikrofon izni verilmedi. Site ayarlarÄ±ndan mikrofonu aÃ§Ä±n.';
    return false;
  }
}

/* ===== main handler ===== */
async function handleQuery(q){
  // prevent echo: stop any current speech
  try{ speechSynthesis.cancel(); }catch(e){}
  showResponse(q, 'Ä°ÅŸleniyor...');
  // local first
  const local = localAnswer(q);
  if(local){
    // if local answer is an object signaling chart
    if(typeof local === 'object' && local.action === 'chart'){
      showResponse(q, 'Grafik oluÅŸturuluyor...');
      drawFirmChart();
      speak('Firma bazlÄ± Ã¼retim grafiÄŸi Ã§izildi. Grafikte ilk sÃ¼tun en yÃ¼ksek Ã¼retimi gÃ¶sterir.');
      return;
    }
    showResponse(q, local);
    speak(local);
    return;
  }
  // else fallback to OpenAI (if key present)
  const ai = await askOpenAI(q);
  if(ai){
    showResponse(q, ai);
    speak(ai);
    return;
  }
  // last fallback
  const fb = 'Bu soruyu yerel veri ile doÄŸrudan yanÄ±tlayamadÄ±m. Daha ayrÄ±ntÄ±lÄ± gÃ¼nlÃ¼k satÄ±r verisini gÃ¶merseniz tarih/Ã¼rÃ¼n/kiÅŸi/fire bazlÄ± cevap verebilirim.';
  showResponse(q, fb);
  speak(fb);
}

/* ===== events ===== */
micBtn.addEventListener('click', async ()=>{
  if(!setupRecognition()) return;
  const ok = await ensureMic();
  if(!ok) return;
  try{
    recognition.start();
  }catch(e){ console.warn('recognition start err', e); transcript.innerText = 'Dinleme baÅŸlatÄ±lamadÄ±.'; }
});

btnSetKey.addEventListener('click', ()=> { apiInput.value = OPENAI_KEY || ''; keyModal.style.display = 'flex'; keyModal.setAttribute('aria-hidden','false'); });
cancelKeyBtn.addEventListener('click', ()=> { keyModal.style.display = 'none'; keyModal.setAttribute('aria-hidden','true'); });
saveKeyBtn.addEventListener('click', ()=> {
  const v = apiInput.value.trim();
  if(!v || !v.startsWith('sk-')){ alert('Gecerli bir OpenAI anahtari girin (sk- ile baslayan).'); return; }
  OPENAI_KEY = v;
  localStorage.setItem(STORAGE_KEY, v);
  keyModal.style.display = 'none';
  showStatusKey();
  speak('OpenAI anahtarÄ±nÄ±z kaydedildi. Sohbet yetenekleri aktif.');
});
btnClearKey.addEventListener('click', ()=> {
  OPENAI_KEY = ''; localStorage.removeItem(STORAGE_KEY); showStatusKey(); speak('OpenAI anahtarÄ± temizlendi.');
});
document.getElementById('btnShowExamples').addEventListener('click', ()=> {
  const examples = [
    'SOFRA iÃ§in ne kadar Ã¼rÃ¼n Ã¼retildi?',
    'ÅžEKERCÄ° iÃ§in ne kadar karabiber hammaddesi kullandÄ±k?',
    '6 Ekim\'de Ã§alÄ±ÅŸan sayÄ±sÄ± kaÃ§?',
    'Ekim ayÄ±nda toplam kaÃ§ kilogram pul biber kullanÄ±ldÄ±?',
    'KaÃ§ farklÄ± firma ile Ã§alÄ±ÅŸtÄ±k?',
    'Toplam kullanÄ±lan hammadde miktarÄ± nedir?',
    'En Ã§ok hangi hammadde kullandÄ±m?',
    'En Ã§ok Ã¼retimde kullanÄ±lan hammadde ve kilosu ne kadar?',
    'En Ã§ok Ã¼retim yaptÄ±ÄŸÄ±m firma hangisi?',
    'En Ã§ok hammadde kullandÄ±ÄŸÄ±m firma hangisi?',
    'Ã‡alÄ±ÅŸma sÃ¼resi nedir?',
    '5 Ekim\'de kaÃ§ saat Ã§alÄ±ÅŸÄ±ldÄ±?',
    'Hammadde - OPP - OMK fireleri ne kadar?',
    'En Ã§ok fire veren Ã¼rÃ¼n hangisi?',
    '9 Ekim\'de hangi Ã¼rÃ¼nlerden kaÃ§ tane hangi firmaya Ã¼retildi?'
  ];
  alert('Ã–rnek sorular:\\n\\n' + examples.join('\\n'));
});
document.getElementById('btnClearOutput').addEventListener('click', ()=> { userText.innerText=''; resText.innerText='Cevap burada gÃ¶rÃ¼necek.'; chartWrap.style.display='none'; if(chartInstance) chartInstance.destroy(); });

/* greeting */
window.addEventListener('load', ()=> {
  // warm up voices
  speechSynthesis.getVoices();
  setTimeout(()=> {
    speak('Merhaba ben Sanita paketleme bilgi asistanÄ±yÄ±m. Bana dilediÄŸinizi sorabilirsiniz.');
  }, 600);
});
</script>
</body>
</html>
