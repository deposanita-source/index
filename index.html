<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SANITA - EKIM KUMULATIF ASISTAN</title>
<style>
  :root{--bg:#020812;--card:#071526;--accent:#22e6c2;--muted:#9fb3ad}
  *{box-sizing:border-box}
  body{margin:0;height:100vh;background:linear-gradient(180deg,#000814,#001e2e);font-family:Inter,system-ui,Segoe UI,Arial;color:#e8ffff;display:flex;align-items:center;justify-content:center;padding:18px}
  .card{width:920px;max-width:96%;border-radius:14px;padding:20px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 40px 100px rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.03)}
  .title{font-weight:800;color:var(--accent);font-size:18px;text-align:center}
  .top{display:flex;align-items:center;justify-content:center;gap:20px;margin-top:14px;flex-direction:column}
  .micOuter{position:relative;width:170px;height:170px;border-radius:999px;display:flex;align-items:center;justify-content:center;margin-top:8px}
  .ring{position:absolute;width:320px;height:320px;border-radius:999px;left:50%;transform:translateX(-50%) scale(.9);pointer-events:none;opacity:0;transition:opacity .12s,transform .25s}
  .ring.on{opacity:1;transform:translateX(-50%) scale(1);animation:ringPulse 1.6s infinite}
  @keyframes ringPulse{0%{box-shadow:0 0 0 0 rgba(34,230,194,0.12)}60%{box-shadow:0 0 0 36px rgba(34,230,194,0)}100%{box-shadow:0 0 0 0 rgba(34,230,194,0)}}
  .micBtn{width:130px;height:130px;border-radius:999px;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,var(--accent),#35d6a6);color:#042018;font-size:40px;font-weight:800;cursor:pointer;box-shadow:0 20px 50px rgba(0,0,0,0.45)}
  .wave{width:340px;height:84px;margin-top:12px;display:flex;align-items:flex-end;gap:7px;opacity:0;transition:opacity .12s}
  .bar{width:9px;background:linear-gradient(180deg,var(--accent),#34d399);border-radius:4px;height:12px;transition:height .06s}
  .transcript{margin-top:14px;color:#dff8f0;font-size:15px;text-align:center;min-height:48px}
  .responseBox{margin-top:14px;padding:14px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);min-height:140px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
  .resText{font-size:18px;line-height:1.5;text-align:center;color:#e6fff4;opacity:0;transform:translateY(8px);transition:opacity .45s,transform .45s;max-width:92%}
  .resText.show{opacity:1;transform:translateY(0)}
  .shine{position:absolute;inset:0;pointer-events:none;background:linear-gradient(90deg,rgba(255,255,255,0.01),rgba(255,255,255,0.06),rgba(255,255,255,0.01));transform:translateX(-120%);opacity:.06;transition:transform 1.2s}
  .shine.run{transform:translateX(120%)}
  .small{font-size:13px;color:var(--muted);text-align:center;margin-top:8px}
  @media (max-width:640px){ .micBtn{width:110px;height:110px;font-size:34px} .wave{width:260px} .card{padding:12px} }
</style>
</head>
<body>
  <div class="card" role="main" aria-label="Sanita Paketleme Bilgi Asistani">
    <div class="title">SANITA PAKETLEME BILGI ASISTANI</div>

    <div class="top">
      <div class="micOuter">
        <div id="ring" class="ring" aria-hidden="true"></div>
        <div id="micBtn" class="micBtn" role="button" title="Dinle">üé§</div>
      </div>
      <div id="wave" class="wave" aria-hidden="true">
        <div class="bar" style="height:8px"></div><div class="bar" style="height:12px"></div><div class="bar" style="height:10px"></div>
        <div class="bar" style="height:14px"></div><div class="bar" style="height:9px"></div><div class="bar" style="height:11px"></div>
        <div class="bar" style="height:8px"></div><div class="bar" style="height:10px"></div>
      </div>
    </div>

    <div id="transcript" class="transcript">Mikrofona dokunun ve sorun. (Konu≈ümanƒ±z burada g√∂r√ºnecek.)</div>

    <div class="responseBox">
      <div id="resText" class="resText">Cevap burada g√∂r√ºnecek.</div>
      <div id="shine" class="shine"></div>
    </div>

    <div class="small">Not: Bu sayfa g√∂m√ºl√º Ekim k√ºm√ºlatif verisi ile √ßalƒ±≈üƒ±r. Mikrofon izni isteƒüi tarayƒ±cƒ± tarafƒ±ndan g√∂sterilecektir.</div>
  </div>

<script>
/* ================== GOMULU OPENAI ANAHTARI BO≈û BIRAKILDI (OPSƒ∞YONEL) ==================
   Eƒüer OpenAI'den geli≈ümi≈ü doƒüal dil sonucu almak istersen buraya anahtar g√∂m (risk kabul√º).
   const OPENAI_API_KEY = "sk-..."; 
   A≈üaƒüƒ±daki kod otomatik olarak yerel mantƒ±kla cevap verir; yetersizse OpenAI'ye sorar. */
const OPENAI_API_KEY = ""; // istersen buraya sk-... koy (gizlilik riski olur)

/* ================== GOMULU VERI (EKIM KUMULATIF) ==================
   Bu veri, sizden gelen √∂zet tabloya dayanarak g√∂m√ºlm√º≈üt√ºr (firma toplamlarƒ± ve ham miktarlar).
   Daha ayrƒ±ntƒ±lƒ± g√ºn bazlƒ± veri g√∂nderirsen (excel) onu da g√∂mebilirim ve date-filtresi etkin olur.
*/
const KUM = [
  {"FIRMA":"SOFRA","URETIM":31477,"HAM_MIK":29055.17},
  {"FIRMA":"KERVAN","URETIM":764,"HAM_MIK":764},
  {"FIRMA":"RECEP CAN","URETIM":1952,"HAM_MIK":4760.07},
  {"FIRMA":"EVERGREEN","URETIM":48122,"HAM_MIK":9921.44},
  {"FIRMA":"BEDIR TEDARIK","URETIM":1964,"HAM_MIK":1702.3},
  {"FIRMA":"ONEN GIDA","URETIM":100,"HAM_MIK":100},
  {"FIRMA":"CELIK NATUREL","URETIM":100,"HAM_MIK":100},
  {"FIRMA":"SEKERCI","URETIM":10484,"HAM_MIK":11828.14},
  {"FIRMA":"GENIM GIDA","URETIM":5173,"HAM_MIK":4760.51},
  {"FIRMA":"AKAR FOOD","URETIM":11454,"HAM_MIK":1170.48},
  {"FIRMA":"MAUN GIDA","URETIM":550,"HAM_MIK":550},
  {"FIRMA":"VENUS","URETIM":3660,"HAM_MIK":2579},
  {"FIRMA":"ANADOLU UNIVERSITESI","URETIM":340,"HAM_MIK":310},
  {"FIRMA":"EKOL FOOD","URETIM":864,"HAM_MIK":723},
  {"FIRMA":"SANITA EVERGREEN","URETIM":672,"HAM_MIK":336},
  {"FIRMA":"MESA","URETIM":70990,"HAM_MIK":9804.16},
  {"FIRMA":"CASH&CARRY","URETIM":13522,"HAM_MIK":15307.8},
  {"FIRMA":"BORTAR","URETIM":797,"HAM_MIK":703.5},
  {"FIRMA":"VKS","URETIM":1794,"HAM_MIK":1002},
  {"FIRMA":"HABIP ALBAYRAK","URETIM":1086,"HAM_MIK":1008.15},
  {"FIRMA":"FATSAT","URETIM":320,"HAM_MIK":320},
  {"FIRMA":"NIOLES","URETIM":750,"HAM_MIK":340.65},
  {"FIRMA":"SALEH","URETIM":4224,"HAM_MIK":1024.32},
  {"FIRMA":"KIRCICEGI","URETIM":50,"HAM_MIK":50},
  {"FIRMA":"MAYA CATERING","URETIM":42,"HAM_MIK":36},
  {"FIRMA":"T DONER","URETIM":500,"HAM_MIK":50},
  {"FIRMA":"FRESH FOOD","URETIM":50,"HAM_MIK":50},
  {"FIRMA":"EGES YEMEK","URETIM":190,"HAM_MIK":190}
];

/* aylik ozet (g√∂nderdiƒüin √∂zet veriye g√∂re) */
const SUMMARY = {
  KISI_SAYISI: 418,
  CALISMA_SURESI: 951.75,
  URETIM_MIKTARI: 212571,
  TOPLAM_HAM: 99126.68,
  HAMMADDE_FIRE: 5.48,
  OMK_FIRE: 28,
  OPP_FIRE: 15.8
};

/* ===== DOM ===== */
const micBtn = document.getElementById('micBtn');
const ring = document.getElementById('ring');
const wave = document.getElementById('wave');
const transcript = document.getElementById('transcript');
const resText = document.getElementById('resText');
const shine = document.getElementById('shine');
const bars = Array.from(document.querySelectorAll('.bar'));

/* ===== helpers ===== */
function fmt(n){ return (typeof n==='number') ? n.toLocaleString('tr-TR') : String(n); }
function speak(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'tr-TR';
    const vs = speechSynthesis.getVoices();
    if(vs && vs.length){
      const tr = vs.find(v=> v.lang && v.lang.toLowerCase().startsWith('tr'));
      if(tr) u.voice = tr;
    }
    u.rate = 1; u.pitch = 1;
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  }catch(e){ console.warn('TTS', e); }
}
function showResp(txt){ resText.classList.remove('show'); resText.innerText=''; setTimeout(()=>{ resText.innerText = txt; resText.classList.add('show'); shine.classList.remove('run'); void shine.offsetWidth; shine.classList.add('run'); }, 80); }

/* ===== analyser visuals ===== */
let audioContext, sourceNode, analyser, animFrame;
function startAnalyser(stream){
  if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
  if(sourceNode) sourceNode.disconnect();
  sourceNode = audioContext.createMediaStreamSource(stream);
  analyser = audioContext.createAnalyser();
  analyser.fftSize = 256;
  sourceNode.connect(analyser);
  const data = new Uint8Array(analyser.frequencyBinCount);
  function frame(){
    analyser.getByteFrequencyData(data);
    for(let i=0;i<bars.length;i++){
      const v = data[i*2] || 0;
      const h = 8 + Math.round(v/6);
      bars[i].style.height = Math.max(8, Math.min(140, h)) + 'px';
    }
    animFrame = requestAnimationFrame(frame);
  }
  frame();
}
function stopAnalyser(){ if(animFrame) cancelAnimationFrame(animFrame); animFrame=null; if(analyser){analyser.disconnect();analyser=null;} if(sourceNode){sourceNode.disconnect();sourceNode=null;} bars.forEach(b=> b.style.height='8px'); }

/* ===== speech recognition setup ===== */
let recognition = null;
function setupRecognition(){
  if(!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)){
    transcript.innerText = 'Tarayƒ±cƒ± ses tanƒ±mayƒ± desteklemiyor. L√ºtfen Chrome kullanƒ±n.';
    return false;
  }
  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new Rec();
  recognition.lang = 'tr-TR';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = ()=> { ring.classList.add('on'); wave.style.opacity='1'; transcript.innerText = 'DINLENIYOR...'; };
  recognition.onresult = (ev)=> {
    const text = ev.results[0][0].transcript;
    transcript.innerText = 'SORDUN: ' + text;
    ring.classList.remove('on'); wave.style.opacity='0'; stopAnalyser();
    processQuestion(text);
  };
  recognition.onerror = (e)=> {
    console.warn('rec err', e);
    transcript.innerText = (e.error==='not-allowed') ? 'Mikrofon izni engellendi.' : 'Ses algƒ±lama hatasƒ±.';
    ring.classList.remove('on'); wave.style.opacity='0'; stopAnalyser();
  };
  recognition.onend = ()=> { ring.classList.remove('on'); wave.style.opacity='0'; stopAnalyser(); };
  return true;
}

/* ===== ensure mic + notification ===== */
async function ensureMic(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    startAnalyser(stream);
    try{ if("Notification" in window && Notification.permission==='default') await Notification.requestPermission(); }catch(e){}
    if("Notification" in window && Notification.permission==='granted') new Notification('Mikrofon izin verildi', {body:'Sanita sizi dinleyebilir.'});
    return stream;
  }catch(e){
    console.warn('getUserMedia err', e);
    transcript.innerText = 'Mikrofon izni verilmedi. Site ayarlarƒ±ndan a√ßƒ±n.';
    return null;
  }
}

/* ===== local NLU (data-driven) ===== */
function localAnswer(q){
  const t = q.toLowerCase();

  // 1) Firma √ºretim toplamƒ±
  for(const r of KUM){
    const name = r.FIRMA.toLowerCase();
    // check tokens
    const tokens = name.split(/[\s&\-_.]+/).filter(Boolean);
    for(const tk of tokens){
      if(t.includes(tk) && tk.length>2){
        return `${r.FIRMA.toUpperCase()} i√ßin toplam √ºretim ${fmt(r.URETIM)} adet. Kullanƒ±lan hammadde: ${fmt(r.HAM_MIK)} kg.`;
      }
    }
  }

  // 2) ≈ûEKERCƒ∞ i√ßin karabiber gibi √∂zel madde sorgusu
  if(t.includes('karabiber')){
    // we don't have ingredient-level breakdown in the embedded summary
    return `G√∂m√ºl√º √∂zet veri sadece firma toplamlarƒ±nƒ± i√ßeriyor; 'karabiber' gibi spesifik hammadde bazlƒ± detaylar satƒ±r satƒ±r kayƒ±tlƒ± deƒüil. Eƒüer g√ºn bazlƒ± hammadde detayƒ± varsa onu g√∂mersen detaylƒ± cevap veririm.`;
  }

  // 3) Tarih bazlƒ± (g√ºn) √ßalƒ±≈üan sayƒ±sƒ± - not available here
  const dateMatch = t.match(/(\d{1,2})\s*ekim/);
  if(dateMatch){
    const day = Number(dateMatch[1]);
    // embedded dataset is monthly totals per firma, not g√ºnl√ºk kayƒ±tlar
    return `Dosyada g√ºnl√ºk (√∂r. ${day} Ekim) bazlƒ± √ßalƒ±≈üan veya √ºr√ºn adedi kayƒ±tlarƒ± g√∂m√ºl√º deƒüil. Detaylƒ± g√ºnl√ºk kayƒ±t saƒülarsan o tarihe ait ki≈üi sayƒ±sƒ±, √ºr√ºn ve fireyi √ßƒ±karƒ±rƒ±m.`;
  }

  // 4) Toplam pul biber miktarƒ± (search ham_mik by product? Not in summary)
  if(t.includes('pul biber') || t.includes('pulbiber') || t.includes('pul-biber') ){
    // we don't have product-level hammadde mapping in this summary
    return `G√∂m√ºl√º √∂zet yalnƒ±zca firma toplamlarƒ± i√ßeriyor; √ºr√ºn d√ºzeyinde (√∂r. \"pul biber\") hammadde kullanƒ±mƒ± i√ßin ayrƒ±ntƒ±lƒ± satƒ±r verisi gerekli. Dilersen o ayrƒ±ntƒ±lƒ± Excel'i g√∂m√ºp hesaplayayƒ±m.`;
  }

  // 5) Ekim ayƒ± toplam hammadde
  if((t.includes('toplam') && (t.includes('hammadde')||t.includes('ham')) ) || t.includes('toplam hammadde')){
    return `Ekim ayƒ±nda toplam kullanƒ±lan hammadde: ${fmt(SUMMARY.TOPLAM_HAM)} kg.`;
  }

  // 6) Ka√ß farklƒ± firma
  if(t.includes('ka√ß') && t.includes('firma')){
    return `Toplam ${KUM.length} farklƒ± firmayla √ßalƒ±≈üƒ±lmƒ±≈ü.`;
  }

  // 7) Toplam kullanƒ±lan hammadde miktarƒ±
  if(t.includes('toplam kullan') && t.includes('hammadde')) {
    return `Toplam kullanƒ±lan hammadde miktarƒ±: ${fmt(SUMMARY.TOPLAM_HAM)} kg.`;
  }

  // 8) En √ßok hangi hammadde kullandƒ±m? -> not available in summary
  if(t.includes('en √ßok') && t.includes('hammadde')){
    // We can say which firma kullandƒ± en cok hammadde
    const map = {};
    KUM.forEach(r=> map[r.FIRMA] = (map[r.FIRMA]||0) + (Number(r.HAM_MIK)||0));
    const sorted = Object.entries(map).sort((a,b)=> b[1]-a[1]);
    if(sorted.length) return `√ñzet veriye g√∂re en √ßok hammadde kullanan firma ${sorted[0][0]}, toplam ${fmt(sorted[0][1])} kg. (Hammadde t√ºrleri √∂zet veri i√ßinde ayrƒ± deƒüil.)`;
  }

  // 9) Toplam √ºretim (t√ºm firma)
  if((t.includes('toplam') && t.includes('uretim')) || t.includes('toplam √ºretim')){
    const total = KUM.reduce((s,r)=> s + (Number(r.URETIM)||0), 0);
    return `Aylƒ±k toplam √ºretim: ${fmt(total)} adet.`;
  }

  // 10) En √ßok √ºretim yapƒ±lan firma
  if(t.includes('en √ßok') && t.includes('√ºretim')){
    const arr = KUM.slice().sort((a,b)=> b.URETIM - a.URETIM);
    if(arr.length) return `En √ßok √ºretim yapƒ±lan firma ${arr[0].FIRMA}, toplam ${fmt(arr[0].URETIM)} adet.`;
  }

  // 11) Toplam √ßalƒ±≈üma s√ºresi
  if(t.includes('√ßalƒ±≈üma s√ºresi') || (t.includes('√ßalƒ±≈üma') && t.includes('s√ºre'))){
    return `Toplam √ßalƒ±≈üma s√ºresi: ${fmt(SUMMARY.CALISMA_SURESI)} saat.`;
  }

  // 12) Belirli tarih (5 Ekim) ka√ß saat √ßalƒ±≈üƒ±ldƒ± -> not in summary
  if(t.includes('5 ekim') && t.includes('saat')){
    return `G√∂m√ºl√º veride g√ºnl√ºk √ßalƒ±≈üma saatleri yok. G√ºnl√ºk saat bilgisi varsa onu g√∂mersen 5 Ekim i√ßin √ßƒ±karƒ±rƒ±m.`;
  }

  // 13) Fireler (HAMMADDE - OPP - OMK)
  if(t.includes('fire') || t.includes('fƒ±r') || t.includes('fƒ±r%' )){
    return `Aylƒ±k √∂zet: Hammadde fire: ${fmt(SUMMARY.HAMMADDE_FIRE)}, OMK (koli) fire: ${fmt(SUMMARY.OMK_FIRE)}, OPP (bobin) fire: ${fmt(SUMMARY.OPP_FIRE)}. (Birimler √∂zette belirtildiƒüi gibi.)`;
  }

  // 14) En √ßok fire veren √ºr√ºn -> need product-level fire data which is not in summary
  if(t.includes('en √ßok') && t.includes('fire') && t.includes('√ºr√ºn')){
    return `√úr√ºn bazlƒ± fire verisi g√∂m√ºl√º √∂zet i√ßinde yok; detaylƒ± satƒ±r veri saƒülarsan hangi √ºr√ºn√ºn en √ßok fire verdiƒüini hesaplarƒ±m.`;
  }

  // 15) 9 Ekim detay (√ºr√ºn, firma, hammadde, ki≈üi, fire, s√ºre) -> not in summary
  if(t.includes('9 ekim') || (t.match(/\d{1,2}\s?ekim/))){
    return `Detaylƒ± g√ºnl√ºk √ºretim raporu g√∂m√ºl√º deƒüil. Eƒüer ham satƒ±r veriyi (tarih, firma, √ºr√ºn, hammadde, miktar, ki≈üi, fire, s√ºre) payla≈üƒ±rsan 9 Ekim i√ßin tam listeyi √ßƒ±karƒ±rƒ±m.`;
  }

  // If not matched, return null to fallback to OpenAI if available
  return null;
}

/* ===== OpenAI fallback (if key provided) ===== */
async function askOpenAI(q){
  if(!OPENAI_API_KEY || !OPENAI_API_KEY.startsWith('sk-')) return null;
  try{
    const prompt = `Kullanici soru (Turkce): "${q}". Veri seti: FIRMA, URETIM, HAM_MIK (ekim ayina ait). Eger cevap veriyle hesaplanabiliyorsa dogrudan sayisal sonuc ver. Kisa ve net turkce cevap ver.`;
    const body = {
      model: "gpt-4o-mini",
      messages: [{role:"system", content:"Turkce veri analizi asistani"}, {role:"user", content:prompt}],
      max_tokens: 600
    };
    const r = await fetch('https://api.openai.com/v1/chat/completions', {
      method:'POST',
      headers: {'Content-Type':'application/json', 'Authorization':'Bearer '+OPENAI_API_KEY},
      body: JSON.stringify(body)
    });
    const j = await r.json();
    const content = j?.choices?.[0]?.message?.content;
    return content || null;
  }catch(e){ console.warn('openai err', e); return null; }
}

/* ===== main question processing ===== */
async function processQuestion(q){
  showResp('ƒ∞≈üleniyor...');
  const local = localAnswer(q);
  if(local){
    showResp(local);
    speak(local);
    return;
  }
  // fallback to OpenAI if possible
  const ai = await askOpenAI(q);
  if(ai){
    showResp(ai);
    speak(ai);
    return;
  }
  const fb = "Bu soruyu yerel veriyle yanƒ±tlayamadƒ±m. G√ºnl√ºk/hammadde-d√ºzeyinde veri saƒülarsanƒ±z daha ayrƒ±ntƒ±lƒ± cevap veririm.";
  showResp(fb);
  speak(fb);
}

/* ===== events ===== */
micBtn.addEventListener('click', async ()=>{
  if(!setupRecognition()) return;
  const stream = await ensureMic();
  if(!stream) return;
  try{
    recognition.start();
  }catch(e){
    console.warn('start err', e); transcript.innerText = 'Dinleme ba≈ülatƒ±lamadƒ±.'; 
  }
});

/* ===== greet on load (may be blocked until user gesture on some browsers) ===== */
window.addEventListener('load', ()=>{
  // warm voices
  speechSynthesis.getVoices();
  try{ speak('Merhaba ben SANITA Paketleme bilgi robotuyum. Bana dilediginizi sorabilirsiniz.'); }catch(e){ console.warn('greet', e); }
});
</script>
</body>
</html>
