<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Sanita Veri Analiz Robotu</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%; width: 100%;
      background-color: #121212; color: #fff;
      font-family: 'Segoe UI', sans-serif;
      display: flex; flex-direction: column;
      align-items: center; justify-content: flex-start;
      overflow: hidden;
    }
    header {
      padding: 1em; text-align: center;
      font-size: 1.8em; font-weight: bold;
    }
    #welcome {
      font-size: 1.2em; margin-bottom: 1em;
      text-align: center; max-width: 90%;
    }
    #controls {
      display: flex; flex-direction: column;
      align-items: center; gap: 1em; margin-bottom: 1em;
    }
    input[type="file"] {
      padding: 0.5em; font-size: 1em;
      background-color: #1f1f1f; color: #fff;
      border: 1px solid #00f; border-radius: 6px;
    }
    button {
      padding: 0.8em 2em; font-size: 1.1em;
      background-color: #1f1f1f; color: #fff;
      border: 2px solid #00f; border-radius: 8px;
      cursor: pointer;
    }
    #wave {
      width: 100%; height: 6px;
      background: linear-gradient(to right, #00f, #0ff);
      animation: wave 1s infinite linear;
      display: none;
    }
    @keyframes wave {
      0% { background-position: 0 0; }
      100% { background-position: 100% 0; }
    }
    #response {
      margin: 1em; font-size: 1.2em;
      text-align: center; max-width: 90%;
    }
    #chart-container {
      width: 90%; max-width: 1000px;
      height: 400px; margin-bottom: 2em;
    }
    canvas {
      width: 100% !important; height: 100% !important;
      background-color: #fff; border-radius: 8px; padding: 1em;
    }
  </style>
</head>
<body>
  <header>ðŸ“Š Sanita Paketleme Veri Analiz Robotu</header>
  <p id="welcome">Ben Sanita Paketleme Veri Analiz Robotuyum. LÃ¼tfen, incelemek istediÄŸiniz dosyayÄ± yÃ¼kleyiniz.</p>
  <div id="controls">
    <input type="file" id="excelFile" accept=".xlsx" />
    <button onclick="startListening()">ðŸŽ¤ Mikrofonu BaÅŸlat</button>
  </div>
  <div id="wave"></div>
  <div id="response"></div>
  <div id="chart-container"><canvas id="chart"></canvas></div>

  <script>
    const OPENAI_API_KEY = "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";
    let excelData = [];

    window.onload = () => {
      setTimeout(() => {
        speak("Ben Sanita Paketleme Veri Analiz Robotuyum. LÃ¼tfen, incelemek istediÄŸiniz dosyayÄ± yÃ¼kleyiniz.");
      }, 1000);
    };

    document.getElementById("excelFile").addEventListener("change", (e) => {
      const reader = new FileReader();
      reader.onload = function (evt) {
        const workbook = XLSX.read(evt.target.result, { type: "binary" });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        excelData = XLSX.utils.sheet_to_json(sheet);
        speak("Dosya yÃ¼klendi baÅŸarÄ±lÄ±.");
        setTimeout(() => {
          speak("Soru sormak iÃ§in Mikrofonu BaÅŸlat butonuna basÄ±nÄ±z.");
        }, 1500);
      };
      reader.readAsBinaryString(e.target.files[0]);
    });

    function startListening() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "tr-TR";
      recognition.start();
      document.getElementById("wave").style.display = "block";

      recognition.onresult = async function (event) {
        const query = event.results[0][0].transcript;
        document.getElementById("wave").style.display = "none";
        document.getElementById("response").innerText = "Soru: " + query;

        if (query.toLowerCase().includes("grafik")) {
          drawChart();
          speak("Grafik gÃ¶steriliyor.");
          return;
        }

        const prompt = `Excel tablosu ÅŸu ÅŸekilde: ${JSON.stringify(excelData)}. KullanÄ±cÄ± ÅŸu soruyu sordu: ${query}. LÃ¼tfen bu soruyu tabloya gÃ¶re analiz et, filtrele, hesapla ve doÄŸru cevabÄ± ver.`;

        try {
          const response = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${OPENAI_API_KEY}`,
            },
            body: JSON.stringify({
              model: "gpt-3.5-turbo",
              messages: [{ role: "user", content: prompt }],
            }),
          });

          const data = await response.json();
          const answer = data.choices?.[0]?.message?.content || "YanÄ±t alÄ±namadÄ±.";
          document.getElementById("response").innerText = "YanÄ±t: " + answer;
          speak(answer);
        } catch (error) {
          document.getElementById("response").innerText = "âŒ Hata: " + error.message;
          speak("YanÄ±t alÄ±namadÄ±. LÃ¼tfen API anahtarÄ±nÄ± veya baÄŸlantÄ±yÄ± kontrol edin.");
        }
      };
    }

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "tr-TR";
      speechSynthesis.speak(utterance);
    }

    function drawChart() {
      const grouped = {};
      excelData.forEach(row => {
        const name = row["KULLANILAN HAMMADDE"];
        const miktar = parseFloat(row["KULLANILAN HAMMADDE MÄ°KTARI"]);
        if (name && !isNaN(miktar)) {
          grouped[name] = (grouped[name] || 0) + miktar;
        }
      });

      const labels = Object.keys(grouped);
      const values = Object.values(grouped);

      const ctx = document.getElementById("chart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Toplam KullanÄ±lan Hammadde (kg)",
            data: values,
            backgroundColor: "rgba(0, 123, 255, 0.6)",
            borderColor: "rgba(0, 123, 255, 1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
  </script>
</body>
</html>
