<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Sanita Sesli Veri Analiz Asistanƒ±</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      height: 100vh; overflow: hidden;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    header {
      font-size: 1.8em; font-weight: bold;
      margin-bottom: 1em; text-align: center;
    }
    #mic {
      width: 100px; height: 100px;
      border-radius: 50%; background-color: #00bcd4;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 20px #00bcd4;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 5px #00bcd4; }
      50% { box-shadow: 0 0 25px #00bcd4; }
      100% { box-shadow: 0 0 5px #00bcd4; }
    }
    #response {
      margin-top: 2em; font-size: 1.2em;
      text-align: center; max-width: 90%;
      animation: fadeIn 2s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    input[type="file"] {
      position: absolute; top: 10px; left: 10px;
      background-color: #fff; color: #000;
      padding: 0.5em; border-radius: 6px;
    }
    #chart-container {
      width: 90%; max-width: 1000px;
      height: 400px; margin-top: 2em;
    }
    canvas {
      width: 100% !important; height: 100% !important;
      background-color: #fff; border-radius: 8px;
    }
  </style>
</head>
<body>
  <input type="file" id="excelFile" accept=".xlsx" />
  <header>üéôÔ∏è Sanita Sesli Veri Analiz Asistanƒ±</header>
  <div id="mic">üé§</div>
  <div id="response">L√ºtfen Excel dosyanƒ±zƒ± y√ºkleyin.</div>
  <div id="chart-container"><canvas id="chart"></canvas></div>

  <script>
    let excelData = [];

    window.onload = () => {
      speak("Merhaba ho≈ügeldiniz, ben Sanita Paketleme B√∂l√ºm√º Yapay Zeka Asistanƒ±yƒ±m. Nasƒ±l yardƒ±mcƒ± olabilirim?");
      setTimeout(() => startListening(), 4000);
    };

    document.getElementById("excelFile").addEventListener("change", (e) => {
      const reader = new FileReader();
      reader.onload = function (evt) {
        const workbook = XLSX.read(evt.target.result, { type: "binary" });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        excelData = XLSX.utils.sheet_to_json(sheet);
        speak("Dosya ba≈üarƒ±yla y√ºklendi. Soru sorabilirsiniz.");
        document.getElementById("response").innerText = "Dosya y√ºklendi. Soru sorabilirsiniz.";
      };
      reader.readAsBinaryString(e.target.files[0]);
    });

    function startListening() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "tr-TR";
      recognition.start();

      recognition.onresult = function (event) {
        const query = event.results[0][0].transcript;
        document.getElementById("response").innerText = "Soru: " + query;
        processQuery(query);
      };
    }

    function processQuery(query) {
      if (excelData.length === 0) {
        speak("√ñnce Excel dosyasƒ±nƒ± y√ºklemelisiniz.");
        return;
      }

      const lowerQuery = query.toLowerCase();
      let filtered = excelData;

      if (lowerQuery.includes("≈üekerci")) {
        filtered = filtered.filter(row => row["Fƒ∞RMA B√ñL√úM√ú"]?.toLowerCase() === "≈üekercƒ±" || row["Fƒ∞RMA B√ñL√úM√ú"]?.toLowerCase() === "≈üekerci");
      }

      if (lowerQuery.includes("pul biber")) {
        filtered = filtered.filter(row => row["√úR√úN ADI"]?.toLowerCase() === "pul biber");
      }

      if (lowerQuery.includes("lokum")) {
        filtered = filtered.filter(row => row["√úR√úN ADI"]?.toLowerCase() === "lokum");
      }

      if (lowerQuery.includes("tarih")) {
        const tarihMatch = lowerQuery.match(/\d{1,2}\s[a-z√ßƒüƒ±√∂≈ü√º]{3,9}/i);
        if (tarihMatch) {
          const tarihKelime = tarihMatch[0];
          filtered = filtered.filter(row => row["TARƒ∞H"]?.toLowerCase().includes(tarihKelime));
        }
      }

      let toplamUretim = 0;
      let toplamHammadde = 0;
      let toplamCalisan = 0;

      filtered.forEach(row => {
        const uretim = parseFloat(row["√úRETƒ∞M Mƒ∞KTARI"]);
        const hammadde = parseFloat(row["KULLANILAN HAMMADDE Mƒ∞KTARI"]);
        const calisan = parseFloat(row["√áALI≈ûAN SAYISI"]);
        if (!isNaN(uretim)) toplamUretim += uretim;
        if (!isNaN(hammadde)) toplamHammadde += hammadde;
        if (!isNaN(calisan)) toplamCalisan += calisan;
      });

      let mesaj = "";
      if (lowerQuery.includes("grafik")) {
        drawChart(filtered);
        mesaj = "Grafik g√∂steriliyor.";
      } else {
        mesaj = `Toplam √ºretim: ${toplamUretim} birim. Toplam hammadde: ${toplamHammadde} kg. Toplam √ßalƒ±≈üan: ${toplamCalisan} ki≈üi.`;
      }

      document.getElementById("response").innerText = mesaj;
      speak(mesaj);
    }

    function drawChart(data) {
      const grouped = {};
      data.forEach(row => {
        const tarih = row["TARƒ∞H"];
        const miktar = parseFloat(row["√úRETƒ∞M Mƒ∞KTARI"]);
        if (tarih && !isNaN(miktar)) {
          grouped[tarih] = (grouped[tarih] || 0) + miktar;
        }
      });

      const labels = Object.keys(grouped);
      const values = Object.values(grouped);

      const ctx = document.getElementById("chart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Tarihe G√∂re √úretim Miktarƒ±",
            data: values,
            backgroundColor: "rgba(0, 255, 204, 0.6)",
            borderColor: "rgba(0, 255, 204, 1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "tr-TR";
      speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>
