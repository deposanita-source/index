<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SANITA - SESLI KUMULATIF ASISTAN (ERKEK SES)</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
:root{
  --bg1:#041526; --bg2:#062a36; --accent:#46e0b2; --soft:#0f3740; --muted:#9fc1b5; --card:rgba(255,255,255,0.03)
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, 'Segoe UI', Arial, sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2)); color:#e8fff6}
.container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.card{width:980px;max-width:96%;border-radius:14px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 30px 80px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
.header{display:flex;align-items:center;gap:14px}
.logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(90deg,#2AE7B4,#1FBBA1);display:flex;align-items:center;justify-content:center;font-weight:800;color:#022018;font-size:20px}
.title{font-weight:800;font-size:18px}
.hint{color:var(--muted);font-size:13px;margin-top:4px}
.main{display:flex;gap:18px;margin-top:16px;align-items:flex-start}
.left{width:340px;display:flex;flex-direction:column;align-items:center}
.micOuter{position:relative;width:300px;height:300px;border-radius:999px;display:flex;align-items:center;justify-content:center}
.ring{position:absolute;width:520px;height:520px;border-radius:999px;left:50%;transform:translateX(-50%) scale(.95);pointer-events:none;opacity:0}
.ring.on{opacity:1;animation:ringPulse 1.6s infinite}
@keyframes ringPulse{0%{box-shadow:0 0 0 0 rgba(70,224,178,0.12)}60%{box-shadow:0 0 0 36px rgba(70,224,178,0)}100%{box-shadow:0 0 0 0 rgba(70,224,178,0)}}
.micBtn{width:170px;height:170px;border-radius:999px;background:linear-gradient(90deg,var(--accent),#2fd9a2);border:none;color:#042018;font-size:56px;font-weight:900;cursor:pointer;box-shadow:0 18px 50px rgba(0,0,0,0.45)}
.wave{display:flex;gap:6px;margin-top:12px;opacity:0;transition:opacity .12s}
.bar{width:12px;background:linear-gradient(180deg,var(--accent),#34d399);border-radius:6px;height:14px;transition:height .06s}
.transcript{min-height:68px;text-align:center;color:#dff8f0;font-size:15px;margin-top:10px;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.01)}
.right{flex:1;display:flex;flex-direction:column;gap:12px}
.response{padding:12px;border-radius:12px;background:var(--card);border:1px solid rgba(255,255,255,0.03);min-height:200px;overflow:auto}
.userText{font-size:14px;color:#cdeee0;margin-bottom:8px}
.resText{font-size:15.5px;line-height:1.45;color:#e6fff4;white-space:pre-wrap}
.examples{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.example{background:rgba(255,255,255,0.02);padding:8px 12px;border-radius:10px;font-size:13px;color:var(--muted);cursor:pointer}
.controls{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
.legend{font-size:13px;color:var(--muted);margin-top:6px}
.small{font-size:13px;color:var(--muted)}
.footer{margin-top:12px;text-align:center;color:var(--muted);font-size:12px}
@media(max-width:920px){ .main{flex-direction:column;align-items:center} .left{width:100%} .micBtn{width:140px;height:140px;font-size:40px} .wave{width:260px} .card{padding:12px} }
</style>
</head>
<body>
<div class="container">
  <div class="card" role="main" aria-label="Sanita Asistan">
    <div class="header">
      <div class="logo">S</div>
      <div>
        <div class="title">SANITA PAKETLEME BILGI ASISTANI</div>
        <div class="hint">Sesli komutla sor â€” detaylÄ± analiz ve tahmini firma-hammadde daÄŸÄ±lÄ±mÄ± gÃ¶mÃ¼lÃ¼</div>
      </div>
      <div style="margin-left:auto" class="controls">
        <button id="chartBtn" class="btn">Hammadde GrafiÄŸi</button>
      </div>
    </div>

    <div class="main">
      <div class="left">
        <div class="micOuter">
          <div id="ring" class="ring" aria-hidden="true"></div>
          <button id="micBtn" class="micBtn" aria-label="Dinle">ðŸŽ¤</button>
        </div>

        <div id="wave" class="wave" aria-hidden="true">
          <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
          <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </div>

        <div id="transcript" class="transcript">Mikrofona dokunun ve sorun. (TarayÄ±cÄ± mikrofon izinlerini kontrol edin.)</div>
        <div class="legend">NOT: Firma-hammadde kÄ±rÄ±lÄ±mÄ± TAHMÄ°NÄ° ise cevapta "TAHMIN" ibaresi bulunur. Kesin kÄ±rÄ±lÄ±m istersen satÄ±r verisi gÃ¶nder.</div>
      </div>

      <div class="right">
        <div class="response" aria-live="polite">
          <div id="userText" class="userText"></div>
          <div id="resText" class="resText">Soru bekleniyor â€” Ã¶rnek: "SOFRA iÃ§in ne kadar Ã¼retim yapÄ±ldÄ±?" veya "Ekim ayÄ±nda toplam kaÃ§ kilo pul biber kullandÄ±k?"</div>
        </div>

        <div class="examples" id="examples"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
          <div class="small">GÃ¶mÃ¼lÃ¼ veri: aylÄ±k hammadde toplamlarÄ± + firma Ã¼retim/hammadde Ã¶zetleri (manuel)</div>
          <div class="small">Cevaplar: metin + erkek sesiyle sesli</div>
        </div>
      </div>
    </div>

    <div class="footer">Ä°lk kullanÄ±mda mikrofon izni isteyecektir. Android Chrome: site izinlerinden mikrofonu aktif edin.</div>
  </div>
</div>

<!-- Chart.js CDN used only to draw graph in a new window -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ================= GÃ–MÃœLÃœ VERÄ°LER ================= */
/* AylÄ±k Ã¶zet */
const MONTH = {
  kisi_sayisi: 418,
  calisma_suresi_saat: 951.75,
  uretim_miktari_adet_reported: 212571,
  uretim_miktari_adet_aggregated: 211251,
  toplam_kullanilan_hammadde_kg_reported: 99126.68,
  toplam_kullanilan_hammadde_kg_aggregated: 98546.68
};

/* Firma Ã¶zetleri (gÃ¶mÃ¼lÃ¼) */
const FIRM_SUMMARY = [
  {firma:"SOFRA", uretim:31477, toplam_hammadde:29055.17},
  {firma:"KERVAN", uretim:764, toplam_hammadde:764.00},
  {firma:"RECEP CAN", uretim:1952, toplam_hammadde:4760.07},
  {firma:"EVERGREEN", uretim:48122, toplam_hammadde:9921.44},
  {firma:"BEDIR TEDARIK", uretim:1964, toplam_hammadde:1702.30},
  {firma:"ONEN GIDA", uretim:100, toplam_hammadde:100.00},
  {firma:"CELIK NATUREL", uretim:100, toplam_hammadde:100.00},
  {firma:"SEKERCI", uretim:10484, toplam_hammadde:11828.14},
  {firma:"GENIM GIDA", uretim:5173, toplam_hammadde:4760.51},
  {firma:"AKAR FOOD", uretim:11454, toplam_hammadde:1170.48},
  {firma:"MAUN GIDA", uretim:550, toplam_hammadde:550.00},
  {firma:"VENUS", uretim:3660, toplam_hammadde:2579.00},
  {firma:"ANADOLU UNIVERSITESI", uretim:340, toplam_hammadde:310.00},
  {firma:"EKOL FOOD", uretim:864, toplam_hammadde:723.00},
  {firma:"SANITA EVERGREEN", uretim:672, toplam_hammadde:336.00},
  {firma:"MESA", uretim:70990, toplam_hammadde:9804.16},
  {firma:"CASH&CARRY", uretim:13522, toplam_hammadde:15307.80},
  {firma:"BORTAR", uretim:797, toplam_hammadde:703.50},
  {firma:"VKS", uretim:1794, toplam_hammadde:1002.00},
  {firma:"HABIP ALBAYRAK", uretim:1086, toplam_hammadde:1008.15},
  {firma:"FATSAT", uretim:320, toplam_hammadde:320.00},
  {firma:"NIOLES", uretim:750, toplam_hammadde:340.65},
  {firma:"SALEH", uretim:4224, toplam_hammadde:1024.32},
  {firma:"KIRCIÃ‡EGI", uretim:50, toplam_hammadde:50.00},
  {firma:"MAYA CATERING", uretim:42, toplam_hammadde:36.00},
  {firma:"T DONER", uretim:500, toplam_hammadde:50.00},
  {firma:"FRESH FOOD", uretim:50, toplam_hammadde:50.00},
  {firma:"EGES YEMEK", uretim:190, toplam_hammadde:190.00}
];

/* Tam hammadde toplam listesi (gÃ¶mÃ¼lÃ¼) */
const HAMMADDE_TOTALS = {
"CAM FISTIGI":160.00,"YENIBAHAR":920.05,"PULBIBER":20107.24,"TUM BIBER":299.00,"DEFNE YAPRAGI":204.46,"KEKIK":2552.74,
"ISOT":4130.77,"ANASON":559.52,"HINDISTAN CEVIZI":4154.01,"IHLAMUR":102.00,"MAVI HASHAS":260.00,"CESNI MILD SEASONING":120.00,
"VANILIN SEKERI":310.00,"SUMAK":1666.49,"BIBERIYE":1436.54,"MIX MARINATION":120.00,"TUZOT":120.00,"TARCIN":2763.43,
"KIMYON":4475.46,"KORI":1670.06,"LIMON TUZU":9441.80,"KARABIBER":3020.10,"TOZ BIBER":14818.43,"NISASTA BUGDAY":100.00,
"MAHLEP":38.80,"KARBONAT":342.00,"COREKOTU":30.00,"GALETA UNU":8770.10,"KUS UZUMU":1620.00,"BEYAZ HASHAS":10.00,
"SARIMSAK":971.80,"NISASTA MISIR":500.00,"ZERDECAL":743.00,"PIZZA SPICE MIX":25.20,"KEBAP SPICE MIX":19.20,"NANE":3869.95,
"MAYDANOZ":496.80,"CHICKEN SEASONING MIX":19.20,"SPICE MIX":19.20,"BAHARAT KARISIMI":26.88,"FESLEGEN":534.90,"SUSAM":2721.90,
"ZENCEFIL":196.10,"KISNIS":55.68,"DEREOTU":26.06,"SOGAN":20.00,"BAMYA KURUSU":5.00,"YER FISTIGI":60.10,"SHAWARMA CESNISI":13.50,
"MASALA CESNISI":12.00,"DENIZ URUNLERI CESNISI":13.50,"YEMEKLIK TUZ":30.00,"TAVUK CESNISI":10.50,"BARBEKU CESNISI":15.00,"ET CESNISI":15.00,
"MISIR UNU":1850.30,"HIMALAYA TUZU":1033.20,"KAJUN CESNISI":12.00,"MIX 7 TURLU":215.20,"DENIZ TUZU":390.72,"MUSKAT":98.40,
"SALATA CESNI":8.10,"PATATES CESNI":18.00,"MAKARNA CESNI":8.10,"KABARTMA TOZU":10.00,"KAYA TUZU":288.00,"BALIK MIX":43.20,
"PIRINC UNU":100.00,"SOS BAHARATI":50.00,"BUGDAY NISASTA":100.00,"AKBIBER":20.00,"GENEL TOPLAM":98988.68
};

/* ================= HESAPLAMA (TAHMINI KIRILIM) ================= */
const totalProduction = FIRM_SUMMARY.reduce((s,f)=> s + (f.uretim||0), 0);
function firmShare(f){ return (f.uretim||0) / (totalProduction||1); }
function buildEstimatedFirmHammadde(){
  const dist = {};
  for(const f of FIRM_SUMMARY) dist[f.firma] = {};
  for(const [h,v] of Object.entries(HAMMADDE_TOTALS)){
    if(h === "GENEL TOPLAM") continue;
    for(const f of FIRM_SUMMARY){
      const estimated = (v||0) * firmShare(f);
      dist[f.firma][h] = +(estimated.toFixed(2));
    }
  }
  return dist;
}
const ESTIMATED_FIRM_HAMMADDE = buildEstimatedFirmHammadde();

/* ================ UI & VOICE ================ */
const micBtn = document.getElementById('micBtn'), ring = document.getElementById('ring'), wave = document.getElementById('wave');
const transcript = document.getElementById('transcript'), userText = document.getElementById('userText'), resText = document.getElementById('resText');
const examplesRoot = document.getElementById('examples'), chartBtn = document.getElementById('chartBtn');

const EXAMPLES = [
  "SOFRA iÃ§in ne kadar Ã¼rÃ¼n Ã¼retildi? ðŸ­",
  "ÅžEKERCÄ° iÃ§in ne kadar karabiber kullandÄ±k? (TAHMIN) ðŸŒ¶ï¸",
  "6 Ekim'de Ã§alÄ±ÅŸan sayÄ±sÄ± kaÃ§? ðŸ‘¥",
  "Ekim ayÄ±nda toplam kaÃ§ kilo pul biber kullanÄ±ldÄ±? ðŸ§‚",
  "KaÃ§ farklÄ± firma ile Ã§alÄ±ÅŸtÄ±k? ðŸ¤"
];
EXAMPLES.forEach(t=>{
  const el = document.createElement('div'); el.className='example'; el.innerText=t; el.onclick=()=>processQuery(t.replace(/ðŸ§‚|ðŸ­|ðŸŒ¶ï¸|ðŸ‘¥|ðŸ¤/g,'')); examplesRoot.appendChild(el);
});

function fmt(n){ return Number(n||0).toLocaleString('tr-TR'); }

/* Choose a Turkish male-like voice if available */
function chooseMaleVoice(){
  const voices = speechSynthesis.getVoices();
  if(!voices || voices.length===0) return null;
  const maleHints = ['Ahmet','Mehmet','Ali','Burak','Yusuf','Murat','Emre','Can','Mustafa','Hasan'];
  let v = voices.find(x=> x.lang && x.lang.toLowerCase().startsWith('tr') && maleHints.some(m=> x.name && x.name.toLowerCase().includes(m.toLowerCase())));
  if(!v) v = voices.find(x=> x.lang && x.lang.toLowerCase().startsWith('tr'));
  if(!v) v = voices[0];
  return v;
}
let preferredVoice = null;
speechSynthesis.onvoiceschanged = ()=> { preferredVoice = chooseMaleVoice(); };
preferredVoice = chooseMaleVoice();

function speakText(txt){
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(txt);
    u.lang = 'tr-TR';
    preferredVoice = preferredVoice || chooseMaleVoice();
    if(preferredVoice) u.voice = preferredVoice;
    u.rate = 1; u.pitch = 1;
    speechSynthesis.speak(u);
    return u;
  }catch(e){ console.warn(e); return null; }
}

/* ========== Quasi-NLP local responder =========== */
function normalize(q){ return (q||'').toString().toLowerCase(); }

function localAnswer(q){
  const s = normalize(q);

  // casual chat
  if(/^(merhaba|selam|hello|hey)\b/.test(s)) return "Merhaba! Ben Sanita Paketleme Bilgi AsistanÄ±. Size nasÄ±l yardÄ±mcÄ± olabilirim?";
  if(/\b(nasÄ±lsÄ±n|nasilsin|naber|ne haber)\b/.test(s)) return "Ä°yiyim, teÅŸekkÃ¼r ederim! Sen nasÄ±lsÄ±n?";
  if(/\b(teÅŸekkÃ¼r|tesekkur|saÄŸol|saol)\b/.test(s)) return "Rica ederim â€” baÅŸka bir ÅŸey isterseniz sorun.";

  // monthly totals
  if(s.includes('kaÃ§ kiÅŸi') || (s.includes('Ã§alÄ±ÅŸan') && s.includes('kaÃ§')) || s.includes('kisi sayisi') ) {
    return `AylÄ±k toplam kiÅŸi sayÄ±sÄ±: ${fmt(MONTH.kisi_sayisi)} kiÅŸi.`;
  }
  if((s.includes('Ã§alÄ±ÅŸma sÃ¼resi')||s.includes('calisma suresi')||s.includes('sÃ¼re')) && (s.includes('kaÃ§')||s.includes('nedir'))){
    return `Ay iÃ§indeki toplam Ã§alÄ±ÅŸma sÃ¼resi: ${fmt(MONTH.calisma_suresi_saat)} saat.`;
  }
  if(s.includes('toplam kullanÄ±lan hammadde') || (s.includes('toplam') && s.includes('hammadde'))){
    return `AylÄ±k toplam kullanÄ±lan hammadde (rapor): ${fmt(MONTH.toplam_kullanilan_hammadde_kg_reported)} kg. (Firma toplamÄ±: ${fmt(MONTH.toplam_kullanilan_hammadde_kg_aggregated)} kg)`;
  }
  if(s.includes('Ã¼retim') && (s.includes('adet')||s.includes('toplam')||s.includes('kaÃ§'))){
    return `AylÄ±k Ã¼retim adedi (rapor): ${fmt(MONTH.uretim_miktari_adet_reported)} adet. (Firma toplamÄ±: ${fmt(MONTH.uretim_miktari_adet_aggregated)} adet)`;
  }

  // hammadde specific
  if(s.includes('pul') && s.includes('biber')) {
    return `AylÄ±k toplam PUL BIBER kullanÄ±mÄ±: ${fmt(HAMMADDE_TOTALS["PULBIBER"])} kg.`;
  }
  if(s.includes('karabiber') || s.includes('kara biber')) {
    if(HAMMADDE_TOTALS["KARABIBER"]) return `AylÄ±k toplam KARABIBER kullanÄ±mÄ±: ${fmt(HAMMADDE_TOTALS["KARABIBER"])} kg.`;
    if(HAMMADDE_TOTALS["TOZ BIBER"]) return `AylÄ±k toplam TOZ BIBER kullanÄ±mÄ± (alternatif): ${fmt(HAMMADDE_TOTALS["TOZ BIBER"])} kg.`;
  }
  if(s.includes('en Ã§ok') && s.includes('hammadde')) {
    let best = null;
    for(const [k,v] of Object.entries(HAMMADDE_TOTALS)){
      if(k.toUpperCase().includes('GENEL')) continue;
      if(!best || v > best[1]) best = [k,v];
    }
    if(best) return `En Ã§ok kullanÄ±lan hammadde: ${best[0]} â€” ${fmt(best[1])} kg.`;
  }

  // firm detection
  for(const f of FIRM_SUMMARY){
    const fname = f.firma.toLowerCase();
    if(s.includes(fname) || s.includes(fname.replace(/\s/g,''))){
      // if asks for hammadde type inside query
      if(s.includes('pul') || s.includes('biber') || s.includes('karabiber') || s.includes('hammadde') || s.includes('hangi')){
        // return estimated breakdown note
        // pick requested hammadde if present
        if(s.includes('pul') && s.includes('biber')){
          const est = ESTIMATED_FIRM_HAMMADDE[f.firma];
          const key = Object.keys(est).find(k=> k.toLowerCase().includes('pul') && k.toLowerCase().includes('biber')) || Object.keys(est).find(k=> k.toLowerCase().includes('pul'));
          const val = key ? est[key] : 0;
          return `TAHMIN: ${f.firma} iÃ§in PUL BIBER â‰ˆ ${fmt(val)} kg (firma Ã¼retim payÄ±na gÃ¶re tahmini daÄŸÄ±lÄ±m).`;
        }
        if(s.includes('karabiber')||s.includes('kara biber')){
          const est = ESTIMATED_FIRM_HAMMADDE[f.firma];
          const val = est["KARABIBER"] || 0;
          return `TAHMIN: ${f.firma} iÃ§in KARABIBER â‰ˆ ${fmt(val)} kg (tahmini).`;
        }
        // generic firm summary + mention estimate
        return `TAHMIN: ${f.firma} â€” toplam Ã¼retim ${fmt(f.uretim)} adet; toplam hammadde â‰ˆ ${fmt(f.toplam_hammadde)} kg. Firma-hammadde kÄ±rÄ±lÄ±mÄ± Ã¼retim payÄ±na gÃ¶re tahmini olarak hesaplanmÄ±ÅŸtÄ±r.`;
      } else {
        return `${f.firma} iÃ§in toplam Ã¼retim: ${fmt(f.uretim)} adet. Toplam kullanÄ±lan hammadde: ${fmt(f.toplam_hammadde)} kg.`;
      }
    }
  }

  // date-specific ask (we don't have row-level)
  const dm = s.match(/(\d{1,2})\s*ekim/);
  if(dm){
    return `GÃ¼n bazlÄ± satÄ±r verisi (Ã¶rn: ${dm[1]} Ekim) gÃ¶mÃ¼lÃ¼ deÄŸil. GÃ¼nlÃ¼k veriyi eklerseniz kesin cevap veririm. Åžu an aylÄ±k ve firma toplamlarÄ±yla sÄ±nÄ±rlÄ±yÄ±z.`;
  }

  // top firm queries
  if((s.includes('en Ã§ok Ã¼retim')||s.includes('encok uretim')||s.includes('en cok Ã¼retim'))){
    const arr = FIRM_SUMMARY.slice().sort((a,b)=> b.uretim - a.uretim);
    if(arr.length) return `En Ã§ok Ã¼retim yapÄ±lan firma: ${arr[0].firma} â€” ${fmt(arr[0].uretim)} adet.`;
  }
  if(s.includes('en Ã§ok hammadde')||s.includes('en cok hammadde')){
    const arr = FIRM_SUMMARY.slice().sort((a,b)=> b.toplam_hammadde - a.toplam_hammadde);
    if(arr.length) return `En Ã§ok hammadde kullanan firma: ${arr[0].firma} â€” ${fmt(arr[0].toplam_hammadde)} kg.`;
  }

  if(s.includes('kaÃ§ farklÄ± firma') || s.includes('kaÃ§ firma')){
    return `Ay iÃ§inde Ã§alÄ±ÅŸÄ±lan farklÄ± firma sayÄ±sÄ±: ${FIRM_SUMMARY.length} firma.`;
  }

  // direct hammadde lookup by name
  for(const key of Object.keys(HAMMADDE_TOTALS)){
    const kl = key.toLowerCase();
    if(s.includes(kl) || s.includes(kl.replace(/\s/g,''))){
      return `AylÄ±k toplam ${key.toUpperCase()} kullanÄ±mÄ±: ${fmt(HAMMADDE_TOTALS[key])} kg.`;
    }
  }

  // fallback suggestions
  return "Soru tam anlaÅŸÄ±lmadÄ±. Ã–rnek sorular:\nâ€¢ 'SOFRA iÃ§in ne kadar Ã¼retim yapÄ±ldÄ±?'\nâ€¢ 'Ekim ayÄ±nda toplam kaÃ§ kg pul biber kullandÄ±k?'\nâ€¢ 'ÅžEKERCÄ° iÃ§in karabiber miktarÄ± nedir (tahmini)?'\nâ€¢ 'En Ã§ok hangi hammadde kullanÄ±ldÄ±?'\nâ€¢ 'KaÃ§ farklÄ± firma ile Ã§alÄ±ÅŸtÄ±k?'\n\nAyrÄ±ca gÃ¼ndelik: 'Merhaba', 'NasÄ±lsÄ±n?'.";
}

/* ================== SpeechRecognition & Flow ================== */
let recognition = null, recognizing=false;

function setupRecognition(){
  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!Rec){
    transcript.innerText = 'TarayÄ±cÄ±nÄ±z sesli komut desteÄŸi saÄŸlamÄ±yor.';
    return false;
  }
  recognition = new Rec();
  recognition.lang = 'tr-TR';
  recognition.interimResults = false;
  recognition.continuous = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = ()=>{
    recognizing = true;
    ring.classList.add('on');
    wave.style.opacity='1';
    transcript.innerText = 'DINLENIYOR...';
  };
  recognition.onresult = async (ev)=>{
    recognizing = false;
    ring.classList.remove('on');
    wave.style.opacity='0';
    const txt = ev.results[0][0].transcript;
    transcript.innerText = 'SORDUN: ' + txt;
    await handleQuery(txt);
  };
  recognition.onerror = (e)=>{
    recognizing = false;
    ring.classList.remove('on');
    wave.style.opacity='0';
    console.warn('rec error', e);
    if(e.error === 'not-allowed') {
      transcript.innerText = 'Mikrofon engellendi. TarayÄ±cÄ± izinlerini kontrol edin.';
      speakText('Mikrofon izni engellendi. LÃ¼tfen tarayÄ±cÄ± izinlerini kontrol edin.');
    } else {
      transcript.innerText = 'Ses algÄ±lama hatasÄ±.';
    }
  };
  recognition.onend = ()=>{
    recognizing = false;
    ring.classList.remove('on');
    wave.style.opacity='0';
  };
  return true;
}

async function ensureMicAndAnimate(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const src = ctx.createMediaStreamSource(stream);
      const analyser = ctx.createAnalyser(); analyser.fftSize = 256; src.connect(analyser);
      const data = new Uint8Array(analyser.frequencyBinCount);
      function frame(){
        analyser.getByteFrequencyData(data);
        const bars = document.querySelectorAll('.bar');
        for(let i=0;i<bars.length;i++){
          const v = data[i*2]||0;
          const h = Math.min(140, 8 + Math.round(v/6));
          bars[i].style.height = h + 'px';
        }
        if(recognizing) requestAnimationFrame(frame);
      }
      frame();
    }catch(e){ console.warn('analyser', e); }
    return true;
  }catch(e){
    console.warn('getUserMedia', e);
    transcript.innerText='Mikrofon izni verilmedi veya tarayÄ±cÄ± desteklemiyor.';
    speakText('Mikrofon izni verilmedi. LÃ¼tfen tarayÄ±cÄ± izinlerini kontrol edin.');
    return false;
  }
}

/* User query flow: stop recognition while assistant speaks */
async function handleQuery(text){
  document.getElementById('userText').innerText = 'Soru: ' + text;
  document.getElementById('resText').innerText = 'Ä°ÅŸleniyor...';
  // compute answer
  const ans = localAnswer(text);
  // abort recognition to avoid picking up own voice
  try{ recognition && recognition.abort(); }catch(e){}
  // speak using preferred voice (male)
  const u = new SpeechSynthesisUtterance(ans);
  u.lang = 'tr-TR';
  preferredVoice = preferredVoice || chooseMaleVoice();
  if(preferredVoice) u.voice = preferredVoice;
  u.rate = 1; u.pitch = 1;
  // display answer
  document.getElementById('resText').innerText = ans;
  // speak and after speaking do not auto-restart (user must press mic again)
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
  u.onend = ()=> { transcript.innerText = 'Cevap verildi. Yeni soru iÃ§in mikrofonu tekrar baÅŸlatÄ±n.'; };
}

/* mic button */
document.getElementById('micBtn').addEventListener('click', async ()=>{
  if(!setupRecognition()) return;
  const ok = await ensureMicAndAnimate();
  if(!ok) return;
  try{ recognition.start(); }catch(e){ console.warn(e); transcript.innerText='Dinleme baÅŸlatÄ±lamadÄ±.'; }
});

/* populate examples clickable */
EXAMPLES.forEach(t=>{
  // already added above
});

/* Chart button opens new window with Chart.js bar */
document.getElementById('chartBtn').addEventListener('click', ()=>{
  const entries = Object.entries(HAMMADDE_TOTALS).filter(e=> e[0] !== "GENEL TOPLAM").sort((a,b)=> b[1]-a[1]).slice(0,20);
  const labels = entries.map(e=> e[0]), data = entries.map(e=> e[1]);
  const chartHtml = `<!doctype html><html><head><meta charset="utf-8"/><title>Hammadde GrafiÄŸi</title><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><style>body{background:#001222;color:#fff;font-family:Arial;padding:18px}</style></head><body><h3>En Ã‡ok KullanÄ±lan Hammadde (Top ${labels.length})</h3><canvas id="c" width="1200" height="600"></canvas><script>const ctx=document.getElementById('c').getContext('2d'); new Chart(ctx,{type:'bar',data:{labels:${JSON.stringify(labels)},datasets:[{label:'Kg',data:${JSON.stringify(data)},backgroundColor:'rgba(70,224,178,0.9)'}]},options:{scales:{y:{beginAtZero:true}}}});</script></body></html>`;
  const w = window.open('', '_blank');
  w.document.write(chartHtml); w.document.close();
});

/* initial greeting */
window.addEventListener('load', ()=>{
  speechSynthesis.getVoices(); // prime voices
  setTimeout(()=> {
    preferredVoice = chooseMaleVoice();
    const g = "Merhaba, ben Sanita paketleme bilgi asistanÄ±yÄ±m. Bana dilediÄŸiniz soruyu sorun. Mikrofonu baÅŸlatmak iÃ§in daireye dokunun.";
    const u = speakText(g);
    if(u) u.onend = ()=> { transcript.innerText = 'Mikrofonu baÅŸlatmak iÃ§in daireye dokunun.'; };
  }, 600);
});
</script>
</body>
</html>
